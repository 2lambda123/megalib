#! /bin/bash


help() {
  echo ""
  echo "msimconcatter - script for MEGAlib";
  echo "(C) by Andreas Zoglauer"
  echo "";
  echo "Usage:";
  echo "    msimconcatter [long list of sim files]";
  echo "";
  echo "Example:";
  echo "    msimconcatter RunTest*.sim";
  echo "";
  echo "This script creates a concatenation simfile always named Concat.sim"
  echo "";
}

if [ $# -eq 0 ]; then
    echo "Error: This script requires one input parameter, not $#"
    exit -1;
fi

Files=( "$@" )

ConcatFileName="Concat.sim"

# Make sure the output file does not exist
if [ -f ${ConcatFileName} ]; then
  echo "Error: The concatenation file already exists: ${ConcatFileName}"
  exit 1
fi

# Determine if the first file is zipped
if [[ ${Files[0]} == *.gz ]]; then
  Zip="yes"
else
  Zip="no"
fi

# Create a concatenation file
echo "# Concatenation file generated by msimconcatter" >> ${ConcatFileName}

TEMP=`mktemp`
if [[ "${Zip}" == "yes" ]]; then
  gunzip -c ${Files[0]} 2> /dev/null | head -n 100 > ${TEMP}
  # Remark: 2> /dev/null suppresses a "unexpected end of file" error message since the file is obviously not yet closed
else 
  head -n 100 ${Files[0]} > ${TEMP}
fi
  
while read LINE
do
  # Keep all information but: #, Seed, TB
  FIRST=${LINE%% *}
  if [ "${FIRST}" == "SE" ]; then
    break
  fi
  if ( [ "${FIRST}" != "#" ] && [ "${FIRST}" != "Seed" ] && [ "${FIRST}" != "TB" ] ); then
    echo "${LINE}" >> ${ConcatFileName}
  fi
done < ${TEMP}
rm ${TEMP}

echo " " >> ${ConcatFileName}

for File in "${Files[@]}"; do
  echo "IN ${File}" >> ${ConcatFileName}
done
    
echo "EN" >> ${ConcatFileName}
echo " " >> ${ConcatFileName}

# Zip the concatenation file if desired
if [[ "${Zip}" == "yes" ]]; then
  gzip ${ConcatFileName}
fi

exit 0;
