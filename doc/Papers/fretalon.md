---
title: >-
    Fretalon: MEGAlib's detector calibration framework
tags:
  - C++
  - gamma ray
  - detector calibration
authors:
  - name: Andreas Zoglauer
    orcid: 0000-0000-0000-0000
    affiliation: [1]
affiliations:
 - index: 1
   name: Space Sciences Laboratory, University of California at Berkeley, Berkeley, CA, USA
date: 3 March 2023
bibliography: fretalon.bib
---

# Summary

`Fretalon` is a framework which simplifies the implementation of the multi-step calibration pipeline of modern gamma-ray detectors.
It provides templates for typical data set and analysis steps, handles the data as is passes through the individual steps of the pipeline, supervises the operation of the pipeline, and enables the setup of the analysis from a user interface or via a XML configuration file.
The application developer just needs to customize the individual analysis steps, the overall data flow and management is handled by the framework.
`Fretalon` is the newest core tool of MEGAlib [Ref], the Medium-Energy Gamma-ray library, which enables the full data-analysis from simulation to high-level data-analysis for a wide range of gamma-ray instruments for space and ground applications.
Calibration was the last element not handled within MEGAlib, and `Fretalon` closed this gap.
As part of MEGAlib, `Fretalon` is written in C++ and utlizes the ROOT data-analysis framework [Ref].

<!--- Within MEGAlib, `Fretalon` covers the initial segement of the analysis pipeline, which converts the data from the raw, measured data, i.e., the analog-digital converter units as well as detector/strip/pixel IDs, into physical units, i.e. the interaction locations and the amount of deposited energy at that location. --->


# Statement of need

Modern gamma-ray telescopes, such as COSI [Ref], GRIPS [Ref], GECCO [Ref], or ComPair [Ref] have deep, multi-step data pipelines and they all use MEGAlib for at least some of their data-analysis needs.
COSI, the Compton Spectrometer and Imager, is the most technologically advanced of these detector systems, including the analysis pipeline.
COSI's pipeline includes various steps in the calibration stage (e.g., coincidence search, energy calibration, charge sharing and charge loss correction, position calibration), in the event reconstruction stage (e.g., charged particle and gamma-ray tracking, background identification), as well as in the high-level analysis stage (e.g., event selection, imaging, spectral and polarization analysis).
Most of these individual steps are close to identical for different detector and instrument types and a single tool can handle them. For example, MEGAlib's `Cosima` tool handles simulations for various instrument types, its `Revan` tool handles the event reconstruction, and `Mimrec` the high-level analysis.
The calibration, however, needs to be adapted to the specific detectors, their number and arrangement, their vendor specfic characteristics, their read-out electronics, and the environment in which they operate.
As consequence, the calibration stage cannot be handled by one pre-existing tool, but needs to be adaptable and adapted to each new detector system.
For that task, we have written the `Fretalon` framework.
Its name is a mix of the first letters of the word framework, and the french word for calibration "Ã©talonnage".
The specific calibration application written using `Fretalon` transfers the data from the raw, measured data which is the output of the detector into physical units, i.e., from analog-digital converter units, detector/strip/pixel IDs, time, detector orientation, etc., into the interaction locations, the amount of deposited energy at that location, and event times.
This data can then be used by the other `MEGAlib` tools.

# Key design features

`Fretalon` needs to implement a set of design requirements to handle the various steps of the calibration in a uniform way. These include:

## Data
The raw data is organized in read-outs (base class MReadOut) containing individual measurements, the read-out data (base class MReadOutData), as well as the detector element which performed the measurement, the read-out element (base class MReadOutElement). Derived classes from MReadOutElement can contain more specific descriptions of what performed the measurement. For example MReadOutElementDoubleStrip represents a cross-strip detector similar to the used in COSI, and contains the detector ID, the detector side (top or bottom), as well as the strip ID. Similarly, derived classes from MReadOutData contain more specific information about what was measured, such as analog-digital converter values (class MReadOutDataADValues), timing (class MReadOutDataTiming), etc. These can be combined into higher level read-outs via encapsulation.

All measured data of an event (i.e. all data generated by one gamma-ray plus various other sensor data) is collected in a read-out assembly (class MReadOutAssembly). This read-out Assembly is then passes through the individual steps of Fretalon.

## Analysis modules
Each step in the pipeline is encapsulated in one module (class `MModule`).
Each module knows which step it provides (e.g. "energy calibration"), and which steps have to be done before (e.g. "read the data", "coincidence search"). This enables the user interface to automatically arrange the modules and provide a default sequence.
Each module provides an initilization function (`Initialize`) which, for example, reads in calibration data sets, and a finalize function (`Finalize`) which, for example, prints or stores diagnostics, closes data files, etc.
Each module knows if it can only be run in single-thread-mode (e.g. coincidence-search or event saving need to process all the events in sequence), or can be multi-threaded (e.g. energy calibration can be parallelized). 
Despite the option of internal multi-processing, the module needs to make sure that the events exit the module in the same sequence as they entered it - unless the module specifically is intended to sort the events by time or combines events.
Each module has a function to process the read-out assembly (function `AnalyzeEvent`). The actual calibration happens in this function.

## Data and process management: The Supervisor
A supervisor (class `MSupervisor`) sets up the user interface and accepts input through it. 
It manages the passage of the read-out assemblies through the modules, times their processing in each module and can spawn additional threads in modules which support multi-processing to prevent bottelnecks in the analysis.

## The automatically genrated user interface
Each module is associate to a user interface (class derived from class `MGUIOptions`) which allows to set specific data or options (e.g., input files and settings), and to a user interface which allows to display data (class derived from class `MGUIExpo`).
A user interface allows to select the chosen modules, set their options, displays results, and enables to start and stop the processing.

In the end, the only classes which the user must modify are the overall assmebly, the read-out assembly and the modules and their associated UI classes.


# Example applications

## The MEGAlib included example

The MEGAlib advances examples directtory contains an example on how to setup and compile a `Fretalon` based program, how setup the modules.

## Nuclearizer

Nuclearizer [Ref, Ref, Ref] is the COSI specific calibration application, the tool `Fretalon` was originally designed for. It can be found in its own [Github repository](https://github.com/cositools/nuclearizer).


# Availability

`Fretalon` is available as part of MEGAlib 3 via [Github](https://github.com/zoglauer/megalib).

# Acknowledgements

The development of `Fretalon` was sponsored under NASA Astrophysics Research and Analysis grants NNX14AC81G and 80NSSC19K1389.



# Mathematics

Single dollars ($) are required for inline mathematics e.g. $f(x) = e^{\pi/x}$

Double dollars make self-standing equations:

$$\Theta(x) = \left\{\begin{array}{l}
0\textrm{ if } x < 0\cr
1\textrm{ else}
\end{array}\right.$$

You can also use plain \LaTeX for equations
\begin{equation}\label{eq:fourier}
\hat f(\omega) = \int_{-\infty}^{\infty} f(x) e^{i\omega x} dx
\end{equation}
and refer to \autoref{eq:fourier} from text.

# Citations

Citations to entries in paper.bib should be in
[rMarkdown](http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html)
format.

If you want to cite a software repository URL (e.g. something on GitHub without a preferred
citation) then you can do it with the example BibTeX entry below for @fidgit.

For a quick reference, the following citation commands can be used:
- `@author:2001`  ->  "Author et al. (2001)"
- `[@author:2001]` -> "(Author et al., 2001)"
- `[@author1:2001; @author2:2001]` -> "(Author1 et al., 2001; Author2 et al., 2002)"

# Figures

Figures can be included like this:
![Caption for example figure.\label{fig:example}](figure.png)
and referenced from text using \autoref{fig:example}.

Figure sizes can be customized by adding an optional second parameter:
![Caption for example figure.](figure.png){ width=20% }

# Acknowledgements

We acknowledge contributions from Brigitta Sipocz, Syrtis Major, and Semyeong
Oh, and support from Kathryn Johnston during the genesis of this project.

# References
